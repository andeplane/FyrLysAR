# Fastfile for fyrlysar iOS App
# 
# Usage:
#   bundle exec fastlane build      # Build the app
#   bundle exec fastlane release    # Build, archive, and upload to App Store Connect
#   bundle exec fastlane testflight # Build and upload to TestFlight

default_platform(:ios)

# Configuration
PROJECT_ROOT = File.expand_path("..", __dir__)
BUILD_DIR = File.join(PROJECT_ROOT, "build", "Qt_6_6_1_for_iOS-Release")
XCODEPROJ_PATH = File.join(BUILD_DIR, "fyrlysar.xcodeproj")
SCHEME = "fyrlysar"

def read_version
  version_file = File.join(PROJECT_ROOT, "APP_VERSION")
  File.read(version_file).strip
end

platform :ios do
  desc "Generate Xcode project from Qt"
  lane :generate_xcode do
    # This lane runs qmake to generate the Xcode project
    # You may need to adjust the Qt path based on your installation
    sh("cd #{PROJECT_ROOT} && ./scripts/build_release.sh --generate-only")
  end

  private_lane :_build_release_ipa do |options|
    version = read_version
    message = options[:message] || "Building fyrlysar version"
    UI.message("#{message} #{version}")

    # Generate Xcode project if it doesn't exist, then patch it
    unless File.exist?(XCODEPROJ_PATH)
      UI.message("Generating Xcode project...")
      sh("cd #{PROJECT_ROOT} && ./scripts/build_release.sh --generate-only")
    end
    
    # Run the build script which handles patching
    sh("cd #{PROJECT_ROOT} && ./scripts/build_release.sh --build-only")

    build_options = {
      project: XCODEPROJ_PATH,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: File.join(BUILD_DIR, "output"),
      output_name: "fyrlysar.ipa",
      clean: true,
      skip_codesigning: options[:skip_codesigning] || false,
      skip_archive: options[:skip_archive] || false,
      buildlog_path: File.join(PROJECT_ROOT, "build_logs")
    }
    
    # Add xcargs to disable code signing if skip_codesigning is true
    if options[:skip_codesigning]
      build_options[:xcargs] = "CODE_SIGN_IDENTITY='' CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO"
    end
    
    build_app(build_options)
  end

  desc "Build the app for release"
  lane :build do
    _build_release_ipa(
      message: "Building fyrlysar version",
      skip_codesigning: false
    )
  end

  desc "Build and upload to TestFlight"
  lane :testflight_release do
    _build_release_ipa(message: "Releasing fyrlysar version to TestFlight")

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build and upload to App Store"
  lane :release do
    _build_release_ipa(message: "Releasing fyrlysar version to App Store")

    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Just archive without uploading (for manual submission)"
  lane :archive do
    _build_release_ipa(
      message: "Archiving fyrlysar version",
      skip_archive: false,
      skip_codesigning: true  # Skip code signing for CI builds
    )
  end
end

